function getURLParameter(name){return decodeURIComponent((new RegExp("[?|&]"+name+"=([^&;]+?)(&|#|;|$)").exec(location.search)||[,""])[1].replace(/\+/g,"%20"))||null}function rateDelayUpdate(lamp,amount,$interval){lamp.rateDelayActive=!0,$interval(function(){--lamp.rate_delay,lamp.rate_delay<=0&&(lamp.rateDelayActive=!1)},1e3,amount)}!function(){var app=angular.module("dorfmap",["ngMaterial","cgBusy"]);app.controller("MapController",["$http","$timeout","$scope",function($http,$timeout,$scope){var map=this;map.layer=getURLParameter("layer")||"control",map.menu={},map.menu.clicked=function(type){type.hide=!0,$timeout(function(){type.hide=!1},300)},$http.get("/ajax/menu.json").success(function(data){Object.keys(data).forEach(function(key){map.menu[key]=data[key],map.menu[key].hide=!1,$scope.$emit("update")}),map.menu.shortcuts.function=function(action){map.menu.clicked(map.menu.shortcuts),$http.get("/action/"+action).success(function(){var timeout=0;-1==action.indexOf("amps")&&(timeout=500),$scope.$emit("update")})},map.menu.shortcuts.style={},map.menu.shortcuts.style["margin-left"]="-4px",map.menu.presets.function=function(){map.menu.clicked(map.menu.presets)},map.menu.layers.function=function(layer){map.menu.clicked(map.menu.layers),map.layer=layer},map.menu.layers.style={},map.menu.layers.style["margin-left"]="4px"})}]),app.controller("OverviewController",["$http","$scope","$sce","$interval","$materialDialog",function($http,$scope,$sce,$interval,$materialDialog){var overview=this;overview.lamps={},this.update=function(){var httpGet=$http.get("/list/all.json").success(function(data){Object.keys(data).forEach(function(key){overview.lamps[key]?(overview.lamps[key].status=data[key].status,overview.lamps[key].type=data[key].type,overview.lamps[key].rate_delay=data[key].rate_delay,overview.lamps[key].status_text=data[key].status_text):(overview.lamps[key]=data[key],overview.lamps[key].rateDelayActive=!1,overview.lamps[key].blocked=!1,overview.lamps[key].canAccess=function(){return overview.lamps[key].is_writable&&overview.lamps[key].rate_delay<=0&&!overview.lamps[key].blocked},overview.lamps[key].imageClass=function(){return overview.lamps[key].canAccess()?"lampimage":""},overview.lamps[key].isAuto=function(){return"light_au"===overview.lamps[key].type},overview.lamps[key].image=function(){return"dorfdoor"==key?"/static/dorfdoor.png":(statusName=1===overview.lamps[key].status?"on":"off","hackcenter_blau"===key?"/static/hackcenter_blau_"+statusName+".png":overview.lamps[key].isAuto()?(autoPrefix=0===overview.lamps[key].auto?"no":"",-1===overview.lamps[key].status?"/static/light_"+autoPrefix+"auto.png":"/static/light_"+statusName+"_"+autoPrefix+"auto.png"):-1===overview.lamps[key].status?"/static/"+overview.lamps[key].type+".png":"/static/"+overview.lamps[key].type+"_"+statusName+".png")},overview.lamps[key].styleFunction=function(dup){var style={},l=overview.lamps[key];return dup&&(l=dup),style.left=l.x1,style.top=l.y1,32!=l.x2&&(style.width=l.x2),32!=l.y2&&(style.height=l.y2),style},overview.lamps[key].statusClass=function(){return"infoarea"!=overview.lamps[key].type&&"rtext"!=overview.lamps[key].type?"popup":void 0},overview.lamps[key].class=function(){return"dorfdoor"===key?0===overview.lamps[key].status?"closed":"open":"rtext"===overview.lamps[key].type?"rtext":""},overview.lamps[key].toggle=function($event){if(overview.lamps[key].canAccess()){if("blinkenlight"==overview.lamps[key].type)return void $materialDialog({templateUrl:"/static/templates/blinkencontrol-template.html",targetEvent:$event,controller:function($scope,$hideDialog,$http){$scope.lamp=overview.lamps[key],$scope.loadingPromise=$http.get("ajax/blinkencontrol?device="+key).success(function(data){$scope.animations=data.presets,data.active&&($scope.radioGroup=data.active.raw_string)}),$scope.close=function(){$hideDialog()},$scope.save=function(){$http.post("/ajax/blinkencontrol",{device:$scope.lamp.name,raw_string:$scope.radioGroup}).success(function(){$scope.lamp.status=1}),$scope.close()}}});if("charwrite"==overview.lamps[key].type)return void $materialDialog({templateUrl:"/static/templates/charwrite-template.html",targetEvent:$event,controller:["$scope","$hideDialog","$http",function($scope,$hideDialog,$http){$scope.lamp=overview.lamps[key],$scope.loadingPromise=$http.get("/ajax/charwrite").success(function(data){$scope.modes=data,$scope.radioGroup="custom",-1!=$scope.modes.map(function(m){return m.name}).indexOf($scope.lamp.charwrite_text)&&($scope.radioGroup=$scope.lamp.charwrite_text)}),$scope.customModes=["date","clock","hosts","power"],$scope.close=function(){$scope.lamp.newText="",$hideDialog()},$scope.save=function(){"custom"===$scope.radioGroup&&($scope.radioGroup=$scope.lamp.newText),$http.post("/ajax/charwrite",{device:$scope.lamp.name,text:$scope.radioGroup}).success(function(){$scope.lamp.charwrite_text=$scope.radioGroup}),$scope.close()}}]});overview.lamps[key].blocked=!0,$http.get("/toggle/"+key+"?ajax=1").success(function(data){var oldStatus=overview.lamps[key].status;if(overview.lamps[key].status=parseInt(data.status),overview.lamps[key].auto=data.auto,overview.lamps.infoarea.status_text=$sce.trustAsHtml(data.infoarea),(oldStatus===overview.lamps[key].status||1==oldStatus&&0===overview.lamps[key].status)&&data.rate_delay>0)return overview.lamps[key].rate_delay=data.rate_delay,overview.lamps[key].blocked=!1,void(overview.lamps[key].rateDelayActive||rateDelayUpdate(overview.lamps[key],data.rate_delay,$interval));if(overview.lamps[key].isAuto()){var unsafeStatusText=overview.lamps[key].status_text.toString();1==overview.lamps[key].auto&&-1!=unsafeStatusText.indexOf("(deaktiviert)")?overview.lamps[key].status_text=$sce.trustAsHtml(unsafeStatusText.replace(" (deaktiviert)","")):0===overview.lamps[key].auto&&-1===unsafeStatusText.indexOf("(deaktiviert)")&&(overview.lamps[key].status_text=$sce.trustAsHtml(unsafeStatusText+" (deaktiviert)"))}overview.lamps[key].blocked=!1})}}),overview.lamps[key].styleFunction&&(overview.lamps[key].style=overview.lamps[key].styleFunction()),"string"==typeof overview.lamps[key].status_text&&(overview.lamps[key].status_text=$sce.trustAsHtml(overview.lamps[key].status_text.split(" (rate")[0])),overview.lamps[key].status=overview.lamps[key].status?parseInt(overview.lamps[key].status):0,0===overview.lamps[key].status&&!overview.lamps[key].rateDelayActive&&overview.lamps[key].rate_delay>0&&rateDelayUpdate(overview.lamps[key],overview.lamps[key].rate_delay,$interval)})});$scope.map.loadingPromise||($scope.map.loadingPromise=httpGet)},$scope.$parent.$on("update",overview.update),$interval(this.update,2e4),this.filteredLamps=function(){return Object.keys(overview.lamps).filter(function(k){return overview.lamps[k].layer===$scope.map.layer}).map(function(key){return overview.lamps[key]})}}]),app.directive("lamp",function(){return{restrict:"E",templateUrl:"/static/templates/lamp-template.html"}}),app.directive("dropdownmenu",function(){return{restrict:"E",templateUrl:"/static/templates/dropdownmenu-template.html",scope:{action:"=",header:"=",data:"="}}})}();